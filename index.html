<!DOCTYPE html>
<html lang="fr">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Embedding Advisor Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* gray-50 */
        }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .loader-dots div {
            animation:-bouncedelay 1.4s infinite ease-in-out both;
            width: 12px;
            height: 12px;
            background-color: #4f46e5; /* indigo-600 */
            border-radius: 100%;
            display: inline-block;
        }
        .loader-dots .dot1 { animation-delay: -0.32s; }
        .loader-dots .dot2 { animation-delay: -0.16s; }
        @keyframes -bouncedelay {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .result-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        /* Custom scrollbar for justification text */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 3px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #a5b4fc; border-radius: 3px;}
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #818cf8; }
    </style>
</head>


<body class="text-gray-800">
       <!-- üîó Lien vers la base de donn√©es -->
    <nav class="absolute top-4 left-4">
        <a href="https://huggingface.co/spaces/mteb/leaderboard" 
           target="_blank" 
           class="flex items-center space-x-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition">
            <svg xmlns="http://www.w3.org/2000/svg" 
                 class="h-5 w-5" 
                 fill="none" 
                 viewBox="0 0 24 24" 
                 stroke="currentColor" 
                 stroke-width="2">
                <path stroke-linecap="round" 
                      stroke-linejoin="round" 
                      d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span>Base de donn√©es MTEB</span>
        </a>
    </nav>
    
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-gray-900">
                <span class="gradient-text">AI Embedding Advisor</span> Pro
            </h1>
            <p class="mt-3 text-lg text-gray-600 max-w-2xl mx-auto">Laissez l'IA analyser vos besoins et le benchmark pour une recommandation sur mesure.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            <!-- Colonne de saisie -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg border border-gray-200 h-fit sticky top-8">
                <h2 class="text-2xl font-bold mb-5 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    D√©crivez votre projet
                </h2>
                
                <div class="mb-5">
                    <label for="dataDescription" class="block text-sm font-semibold text-gray-700 mb-2">1. Quels sont vos objectifs ?</label>
                    <textarea id="dataDescription" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ex: 'Je construis un chatbot pour un site e-commerce. Il doit r√©pondre aux questions sur les produits en plusieurs langues, √† partir de descriptions courtes. La vitesse de r√©ponse est critique.'"></textarea>
                    <p class="text-xs text-gray-500 mt-2">Mots-cl√©s : multilingue, documents longs/courts, temps-r√©el, code source, etc.</p>
                </div>

                <div class="mb-6">
                    <label for="useCase" class="block text-sm font-semibold text-gray-700 mb-2">2. Quel est votre cas d'usage principal ?</label>
                    <select id="useCase" class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <button id="analyzeBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center">
                    <span id="btn-text" class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                        Lancer l'Analyse IA
                    </span>
                    <div id="btn-loader" class="hidden h-5 w-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>

            <!-- Colonne des r√©sultats -->
            <div id="results-container" class="lg:col-span-2">
                 <div id="placeholder" class="flex items-center justify-center bg-white/50 p-6 rounded-2xl border-2 border-dashed border-gray-300 h-96">
                    <div class="text-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">Les recommandations de l'IA appara√Ætront ici</h3>
                        <p class="mt-1 text-sm text-gray-500">D√©crivez votre projet pour commencer.</p>
                    </div>
                </div>
                <div id="loading" class="hidden flex flex-col items-center justify-center bg-white p-6 rounded-2xl shadow-lg border-gray-200 h-96">
                    <div class="loader-dots">
                        <div class="dot1"></div><div class="dot2"></div><div class="dot3"></div>
                    </div>
                    <p class="mt-6 text-lg font-semibold text-gray-700">L'expert IA analyse votre demande...</p>
                    <p class="text-sm text-gray-500">Cela peut prendre quelques secondes.</p>
                </div>
                <div id="error" class="hidden flex flex-col items-center justify-center bg-red-50 p-6 rounded-2xl shadow-lg border-2 border-dashed border-red-300 h-96">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h3 class="mt-4 text-lg font-semibold text-red-700">Une erreur est survenue</h3>
                    <p id="error-message" class="mt-2 text-sm text-red-600">Impossible de contacter le LLM. Veuillez r√©essayer.</p>
                </div>
                <div id="results-content" class="hidden space-y-8">
                    <!-- Les cartes de r√©sultats seront inject√©es ici -->
                </div>
            </div>

        </div>
    </div>

<script>

let benchmarkCsvData = "";

async function loadBenchmarkCsv() {
    const csvUrl = "https://raw.githubusercontent.com/samir-aitabbou/AI-Embedding-Advisor-Pro/refs/heads/master/benchmark_data.csv";

    const response = await fetch(csvUrl);
    if (!response.ok) {
        throw new Error("Impossible de charger les donn√©es du benchmark.");
    }

    benchmarkCsvData = await response.text();
    console.log("‚úÖ Benchmark charg√© depuis GitHub !");
}


const USE_CASE_COLUMNS = ['Retrieval', 'Classification', 'Clustering', 'Reranking', 'STS'];

document.addEventListener('DOMContentLoaded', async () => {
    const useCaseSelect = document.getElementById('useCase');
    USE_CASE_COLUMNS.forEach(useCase => {
        const option = document.createElement('option');
        option.value = useCase;
        option.textContent = useCase;
        useCaseSelect.appendChild(option);
    });

    try {
        await loadBenchmarkCsv(); // Chargement du fichier CSV au d√©marrage
        console.log("Benchmark CSV charg√© !");
    } catch (err) {
        console.error("Erreur de chargement du benchmark:", err);
        alert("Erreur : impossible de charger les donn√©es du benchmark.");
    }

    document.getElementById('analyzeBtn').addEventListener('click', handleAnalysis);
});


async function handleAnalysis() {
    const description = document.getElementById('dataDescription').value;
    const useCase = document.getElementById('useCase').value;

    if (description.trim() === '') {
        alert("Veuillez d√©crire votre projet pour obtenir une recommandation pertinente.");
        return;
    }

    const ui = {
        btn: document.getElementById('analyzeBtn'),
        btnText: document.getElementById('btn-text'),
        btnLoader: document.getElementById('btn-loader'),
        placeholder: document.getElementById('placeholder'),
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        errorMessage: document.getElementById('error-message'),
        resultsContent: document.getElementById('results-content'),
    };

    ui.btn.disabled = true;
    ui.btnText.classList.add('hidden');
    ui.btnLoader.classList.remove('hidden');
    ui.placeholder.classList.add('hidden');
    ui.resultsContent.classList.add('hidden');
    ui.error.classList.add('hidden');
    ui.loading.classList.remove('hidden');
    
    try {
        const recommendations = await getLlmRecommendations(description, useCase);
        displayResults(recommendations, useCase); // La fonction displayResults g√©rera l'affichage
        ui.resultsContent.classList.remove('hidden');
    } catch (err) {
        console.error("Error during LLM analysis:", err);
        ui.errorMessage.textContent = err.message || "Une erreur inconnue est survenue.";
        ui.error.classList.remove('hidden');
    } finally {
        ui.loading.classList.add('hidden');
        ui.btn.disabled = false;
        ui.btnText.classList.remove('hidden');
        ui.btnLoader.classList.add('hidden');
    }
}

async function getLlmRecommendations(description, useCase) {
    const apiKey = "AIzaSyBl3jseHBrqSSrv1FP6spyBm0PqMnV6ihQ"; // Note: N'exposez jamais de cl√©s API en production c√¥t√© client.
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    // --- MODIFICATION 1 : PROMPT ---
// Dans getLlmRecommendations, remplacez UNIQUEMENT cette variable :

    const systemPrompt = `
You are an expert AI/ML engineer specializing in embedding models. 
Your **primary and most important task** is to analyze the user's 'Project Description' for relevance before doing anything else.

**RELEVANCE CHECK (DO THIS FIRST):**
1.  Read ONLY the 'Project Description' provided by the user.
2.  Determine if it is a genuine request for embedding model recommendations (e.g., it mentions chatbots, semantic search, RAG, classification, document processing, code, etc.).
3.  If the description is **NOT** a genuine request (e.g., "salut", "comment √ßa va?", "quelle est la date de naissance de Messi?", "√©cris-moi un po√®me", or any simple greeting or unrelated question), you **MUST** follow the 'Off-Topic' instructions.

**JSON RESPONSE LOGIC (STRICT):**

* **If Off-Topic (based on your RELEVANCE CHECK):**
    * You **MUST** set "is_off_topic": true.
    * You **MUST** set "off_topic_message" to this exact string: "Je suis sp√©cialis√© uniquement dans la recommandation de mod√®les d'embedding en fonction des donn√©es de benchmark et de la description de votre projet. Veuillez me fournir ces informations pour une analyse."
    * You **MUST** set "recommendations": [] (an empty array).
    * **Do NOT** analyze the benchmark data. Do NOT try to find models. Your job stops here.

* **If On-Topic (based on your RELEVANCE CHECK):**
    * You **MUST** set "is_off_topic": false.
    * You **MUST** set "off_topic_message": null.
    * **THEN, AND ONLY THEN,** you may proceed to analyze the provided benchmark data.
    * Cross-reference the user's needs (description, 'Main Task') with the benchmark to find the top 3 models.
    * Populate the "recommendations" array with your top 3 findings, including justification and specs.
    * Prioritize the 'Main Task' score but adjust ranking based on constraints mentioned in the description (multilingual, document length, real-time, etc.).

Your response MUST always be a valid JSON object following the schema.
`;

    const userPrompt = `Here is the benchmark data (subset of top models) in CSV format:\n--- BENCHMARK DATA ---\n${benchmarkCsvData}\n--- END BENCHMARK DATA ---\n\nUser request:\n- Main Task: "${useCase}"\n- Project Description: "${description}"\n\nProvide top 3 recommendations in the specified JSON format if applicable.`;

    // --- MODIFICATION 2 : SCH√âMA DE R√âPONSE ---
    const responseSchema = {
        "type": "OBJECT",
        "properties": {
            "is_off_topic": {
                "type": "BOOLEAN",
                "description": "Set to true if the user's request is unrelated to embedding models."
            },
            "off_topic_message": {
                "type": "STRING",
                "description": "The refusal message to show if is_off_topic is true. (Optional)"
            },
            "recommendations": {
                "type": "ARRAY",
                "description": "An array of the top 3 recommended embedding models. (Should be null or empty if is_off_topic is true)",
                "items": {
                    "type": "OBJECT",
                    "properties": {
                        "rank": { "type": "NUMBER" },
                        "model_name": { "type": "STRING" },
                        "score_for_task": { "type": "NUMBER" },
                        "justification": { "type": "STRING" },
                        "key_specs": {
                            "type": "OBJECT",
                            "properties": {
                                "Max_Tokens": { "type": "STRING" },
                                "Parameters": { "type": "STRING" },
                                "Dimensions": { "type": "STRING" }
                            }
                        }
                    }
                }
            }
        },
        "required": ["is_off_topic"] // Seul ce champ est maintenant requis
    };

    const payload = {
        contents: [{ parts: [{ text: userPrompt }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema, temperature: 0.2 },
    };

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    // --- MODIFICATION 3 : GESTION DE LA R√âPONSE ---

    if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
    }

    const result = await response.json();

    // V√©rification de s√©curit√© pour la r√©ponse de l'API
    if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0].text) {
        console.error("R√©ponse invalide ou malform√©e de l'API Gemini:", result);
        throw new Error("R√©ponse invalide de l'API LLM.");
    }
    
    const jsonText = result.candidates[0].content.parts[0].text.trim();
    let parsedResponse;

    try {
        parsedResponse = JSON.parse(jsonText);
    } catch (e) {
        console.error("Erreur de parsing du JSON retourn√©:", jsonText);
        throw new Error("Le LLM a retourn√© un JSON invalide.");
    }
    
    // 1. V√©rifier si la requ√™te √©tait hors sujet
    if (parsedResponse.is_off_topic === true) {
        // C'est hors sujet. Nous retournons un objet "recommandation" sp√©cial
        // que la fonction displayResults() saura afficher comme un message.
        return { 
            recommendations: [{ 
                rank: 0, // Un rang 0 ou sp√©cial
                model_name: "Requ√™te Hors Sujet", 
                score_for_task: 0, 
                justification: parsedResponse.off_topic_message || "La demande n'est pas li√©e √† la recommandation de mod√®les d'embedding.", 
                key_specs: { Max_Tokens: "-", Parameters: "-", Dimensions: "-" } 
            }] 
        };
    }

    // 2. Si ce n'est pas hors sujet, retourner les recommandations normalement
    if (parsedResponse.recommendations && parsedResponse.recommendations.length > 0) {
         return parsedResponse;
    }
   
    // 3. Cas de secours si le JSON est valide mais vide (pas de recommandations trouv√©es)
    return { 
        recommendations: [{ 
            rank: 0,
            model_name: "Aucun mod√®le trouv√©", 
            score_for_task: 0, 
            justification: "L'IA n'a pas pu trouver de mod√®le correspondant pr√©cis√©ment √† vos crit√®res dans le benchmark. Essayez de reformuler votre demande.", 
            key_specs: { Max_Tokens: "-", Parameters: "-", Dimensions: "-" } 
        }] 
    };
}


function displayResults(data, useCase) {
    const resultsContent = document.getElementById('results-content');
    resultsContent.innerHTML = ''; 

    if (!data.recommendations || data.recommendations.length === 0) {
        resultsContent.innerHTML = `<p class="text-gray-600">Le LLM n'a pas pu fournir de recommandation pour cette demande.</p>`;
        return;
    }

    data.recommendations.forEach((rec, index) => {
        // Logique sp√©ciale pour afficher le message hors-sujet ou "aucun r√©sultat"
        if (rec.rank === 0) {
            const card = `
                <div class="result-card fade-in p-6 rounded-2xl border bg-white text-gray-800 shadow-lg border-gray-200" style="animation-delay: ${index * 150}ms;">
                    <div class="flex items-start justify-between">
                        <div>
                            <span class="text-sm font-semibold text-indigo-600">Information</span>
                            <h3 class="text-2xl font-bold text-gray-900 mt-1">${rec.model_name}</h3>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="mt-2 text-sm text-gray-600">
                            ${rec.justification}
                        </div>
                    </div>
                </div>
            `;
            resultsContent.innerHTML += card;
            return; // Passe √† la recommandation suivante (s'il y en a)
        }
        
        // Logique d'affichage normale pour les vraies recommandations
        const isTopPick = rec.rank === 1;
        const cardClass = isTopPick 
            ? 'bg-gradient-to-br from-indigo-600 to-purple-600 text-white shadow-2xl border-transparent' 
            : 'bg-white text-gray-800 shadow-lg border-gray-200';
        const titleClass = isTopPick ? 'text-white' : 'text-gray-900';
        const subtitleClass = isTopPick ? 'text-indigo-200' : 'text-gray-500';
        const justificationClass = isTopPick ? 'text-indigo-100' : 'text-gray-600';
        const specValueClass = isTopPick ? 'text-white' : 'text-gray-800';
        const scoreBgClass = isTopPick ? 'bg-white/20' : 'bg-gray-100';

        const card = `
            <div class="result-card fade-in p-6 rounded-2xl border ${cardClass}" style="animation-delay: ${index * 150}ms;">
                ${isTopPick ? `<div class="absolute top-0 right-6 -mt-3 bg-yellow-400 text-yellow-900 font-bold text-xs px-3 py-1 rounded-full uppercase tracking-wider">Top Recommandation</div>` : ''}
                
                <div class="flex items-start justify-between">
                    <div>
                        <span class="text-sm font-semibold ${isTopPick ? 'text-indigo-300' : 'text-indigo-600'}">Recommandation #${rec.rank}</span>
                        <h3 class="text-2xl font-bold ${titleClass} mt-1">${rec.model_name}</h3>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t ${isTopPick ? 'border-white/20' : 'border-gray-200'}">
                    <h4 class="font-semibold ${isTopPick ? 'text-indigo-200' : 'text-gray-700'}">Analyse de l'expert IA :</h4>
                    <div class="mt-2 text-sm max-h-24 overflow-y-auto custom-scrollbar pr-2 ${justificationClass}">
                        ${rec.justification}
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t ${isTopPick ? 'border-white/20' : 'border-gray-200'}">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold ${isTopPick ? 'text-indigo-200' : 'text-gray-700'}">Score T√¢che (${useCase})</h4>
                        <span class="font-bold text-lg ${titleClass}">${rec.score_for_task}</span>
                    </div>
                    <div class="w-full bg-black/20 rounded-full h-2.5">
                        <div class="bg-gradient-to-r ${isTopPick ? 'from-yellow-300 to-yellow-500' : 'from-indigo-400 to-purple-500'}" style="width: ${rec.score_for_task}%; height: 100%; border-radius: 9999px;"></div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t ${isTopPick ? 'border-white/20' : 'border-gray-200'} grid grid-cols-3 gap-4 text-center">
                    <div class="${scoreBgClass} p-2 rounded-lg">
                        <p class="text-xs ${subtitleClass}">Param√®tres</p>
                        <p class="font-bold text-sm ${specValueClass}">${rec.key_specs.Parameters}</p>
                    </div>
                    <div class="${scoreBgClass} p-2 rounded-lg">
                        <p class="text-xs ${subtitleClass}">Max Tokens</p>
                        <p class="font-bold text-sm ${specValueClass}">${rec.key_specs.Max_Tokens}</p>
                    </div>
                    <div class="${scoreBgClass} p-2 rounded-lg">
                        <p class="text-xs ${subtitleClass}">Dimensions</p>
                        <p class="font-bold text-sm ${specValueClass}">${rec.key_specs.Dimensions}</p>
                    </div>
                </div>
            </div>
        `;
        resultsContent.innerHTML += card;
    });
}
</script>

</body>
</html>
